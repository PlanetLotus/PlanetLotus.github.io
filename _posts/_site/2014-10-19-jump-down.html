<p>This feature was simple enough. I was actually very fortunate…it worked on
the first try. Because of its simplicity, this one’s a little easier to show,
and the single commit can be found on my <a href="https://github.com/PlanetLotus/keen5-linux/commit/478e558128273ffd0bff4101a6d213475e3e9519">github
repo</a>.</p>

<p>The algorithm is pretty straightforward, but maybe documenting it here will
help someone (…or, more likely, myself) in the future. Below was my approach
to the problem. A video demo is embedded at the bottom.</p>

<h3 id="the-problem">The Problem</h3>

<p>“Jumping down” refers to the ability to press a button to fall through the
platform you’re currently standing on. In Commander Keen 5, this is possible on
moving platforms and any other tiles that have top but not bottom collision.</p>

<p>Specific to Commander Keen, you have to be holding the down arrow key (which
makes your character look down) and then press ctrl to jump down. If
the conditions aren’t met, this simply does nothing. If they are met, my
algorithm simply turns off y-collision for a single loop, letting gravity take over.</p>

<h3 id="the-specifics">The Specifics</h3>

<p>The first step was to detect when the player was holding down the down arrow. I
already have a
<a href="https://github.com/PlanetLotus/keen5-linux/blob/master/src/Controller.cpp">class</a>
for this but didn’t look for this key yet.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">SDL_SCANCODE_LCTRL</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">controllerRef</span><span class="p">.</span><span class="n">isHoldingDown</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">controllerRef</span><span class="p">.</span><span class="n">isHoldingCtrl</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">jumpDown</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controllerRef</span><span class="p">.</span><span class="n">isHoldingDown</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">jump</span><span class="p">();</span>
        <span class="n">lookTimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">controllerRef</span><span class="p">.</span><span class="n">isHoldingCtrl</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Next, the <code class="highlighter-rouge">jumpDown()</code> method. The goal here is, more precisely, to check
whether we can jump down.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">Player</span><span class="o">::</span><span class="n">jumpDown</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isOnGround</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">platformStandingOn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Tile</span><span class="o">*</span> <span class="n">tile</span> <span class="o">=</span> <span class="n">getTileUnderFeet</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tile</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">tile</span><span class="o">-&gt;</span><span class="n">getCollideBottom</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">tile</span><span class="o">-&gt;</span><span class="n">getCollideTop</span><span class="p">())</span>
            <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Verified that Keen is on a platform or valid tile to jump down from
</span>    <span class="c1">// Turn off collision for one update loop
</span>    <span class="n">isOnGround</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">platformStandingOn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">isJumpingDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">lookTimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Note the <code class="highlighter-rouge">isJumpingDown = true</code> at the bottom. This tells code in the
<code class="highlighter-rouge">update()</code> loop to ignore y-collision. The <code class="highlighter-rouge">update()</code> code isn’t organized such
that it’s very easy to show, but the jump down functionality is pretty simple.
For anything that would normally depend on y-collision (such as tile and
platform collision), it does an additional check for <code class="highlighter-rouge">isJumpingDown</code>.
If it’s true, it doesn’t do its routine check. Then, at the bottom of
<code class="highlighter-rouge">update()</code>, I set <code class="highlighter-rouge">isJumpingDown = false</code> to reset it.</p>

<iframe width="560" height="315" src="//www.youtube.com/embed/xqy41fm0uWc" frameborder="0" allowfullscreen=""></iframe>
